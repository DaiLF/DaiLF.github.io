# å•ä¾‹æ¨¡å¼
> å•ä¾‹æ¨¡å¼ï¼ˆSingleton Patternï¼‰æ˜¯ä¸€ç§å¸¸ç”¨çš„è½¯ä»¶è®¾è®¡æ¨¡å¼ï¼Œè¯¥æ¨¡å¼çš„ä¸»è¦ç›®çš„æ˜¯ç¡®ä¿**æŸä¸€ä¸ªç±»åªæœ‰ä¸€ä¸ªå®ä¾‹å­˜åœ¨**ã€‚  

å•ä¾‹æ¨¡å¼å±äºåˆ›å»ºå‹æ¨¡å¼ï¼Œå®ƒæä¾›äº†ä¸€ç§æœ€ä½³åˆ›å»ºå¯¹è±¡çš„æœ€ä½³æ–¹å¼ï¼Œè¿™ç§æ¨¡å¼æ¶‰åŠåˆ°ä¸€ä¸ªå•ä¸€çš„ç±»ï¼Œæ”¹ç±»è´Ÿè´£åˆ›å»ºè‡ªå·±çš„å¯¹è±¡ï¼ŒåŒæ—¶ç¡®ä¿åªæœ‰ä¸€ä¸ªå•å¯¹è±¡è¢«åˆ›å»ºï¼Œè¿™ä¸ªç±»æä¾›äº†ä¸€ç§è®¿é—®å…¶å”¯ä¸€çš„å¯¹è±¡çš„æ–¹å¼ï¼Œå¯ä»¥ç›´æ¥è®¿é—®ï¼Œä¸éœ€è¦å®ä¾‹åŒ–è¯¥ç±»çš„å¯¹è±¡ã€‚

âœ” **æ³¨æ„ï¼š**
- å•ä¾‹ç±»åªèƒ½æœ‰ä¸€ä¸ªå®ä¾‹
- å•ä¾‹ç±»å¿…é¡»è‡ªå·±åˆ›å»ºè‡ªå·±çš„å”¯ä¸€å®ä¾‹
- å•ä¾‹ç±»å¿…é¡»ç»™æ‰€æœ‰çš„å…¶å®ƒå¯¹è±¡æä¾›è¿™ä¸ªå®ä¾‹

## 1. Python å®ç°å•ä¾‹æ¨¡å¼çš„å‡ ç§æ–¹å¼

### 1.1 ä½¿ç”¨æ¨¡å—
å…¶å®ï¼ŒPythonçš„æ¨¡å—å°±æ˜¯ä¸€ä¸ªå•ä¾‹æ¨¡å¼ï¼Œæ¨¡å—åœ¨ç¬¬ä¸€å¯¼å…¥çš„æ—¶å€™å°±ä¼šäº§ç”Ÿä¸€ä¸ª `.pyc` æ–‡ä»¶ï¼Œå½“äºŒæ¬¡å¯¼å…¥çš„æ—¶ï¼Œä¼šç›´æ¥åŠ è½½ `.pyc` æ–‡ä»¶ï¼Œè€Œä¸ä¼šå†æ¬¡æ‰§è¡Œæ¨¡å—ä»£ç ã€‚å› æ­¤ï¼Œæˆ‘ä»¬åªéœ€è¦å°†ç›¸å…³çš„å‡½æ•°å’Œæ•°æ®å®šä¹‰åœ¨ä¸€ä¸ªæ¨¡å—ä¸­ï¼Œå°±å¯ä»¥è·å¾—ä¸€ä¸ªå•ä¾‹å¯¹è±¡ã€‚

### 1.2 ä½¿ç”¨è£…é¥°å™¨  
è£…é¥°å™¨å¤–å±‚å˜é‡å®šä¹‰ä¸€ä¸ªå­—å…¸ï¼Œé‡Œé¢å­˜æ”¾è¿™ä¸ªç±»çš„å®ä¾‹ï¼Œå½“ç¬¬ä¸€æ¬¡åˆ›å»ºå®ä¾‹åå°†è¯¥å®ä¾‹ä¿å­˜åˆ°è¿™ä¸ªå­—å…¸åˆ°é‚£ä¸ªä¸­ï¼Œä»¥åæ¯æ¬¡åˆ›å»ºå¯¹è±¡çš„æ—¶å€™ï¼Œç›´æ¥åˆ¤æ–­å­—å…¸ä¸­æ˜¯å¦å­˜åœ¨å®ä¾‹ï¼Œå¦‚æœå­˜åœ¨ç›´æ¥è¿”å›ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™åˆ›å»ºå¹¶ä¿å­˜ã€‚

```python
def singleton(cls):
    _instance = {}
    def _singleton(*args, **kwargs):
        if cls not in _instance:
            _instance[cls] = cls(*args, **kwargs)
        return _instance
    return _sigleton

@singleton
class A(object):
    a = 1
    def __init__(self, x=0):
        self.x = x
        print("Init Method of A")

a1 = A(2)
a2 = A(3)
print(id(a1), id(a2))
```

### 1.3 ä½¿ç”¨ç±»
è°ƒç”¨ç±»ä¸­çš„ `instance` æ–¹æ³•ã€‚

```python
class Singleton(object):
    def __init__(self, *args, **kwargs):
        pass
    
    @classmethod
    def get_instance(cls, *args, **kwargs):
        # åˆ©ç”¨åå°„æœºåˆ¶ï¼Œçœ‹çœ‹è¿™ä¸ªç±»æ˜¯å¦æœ‰_instanceå±æ€§
        if not hasattr(Singletonm, "_instance"):
            Singleton._instance = Singleton(*args, **kwargs)
        return Singleton._instance

s1 = Singleton()    # ä½¿ç”¨è¿™ç§æ–¹å¼æ— æ³•ä¿è¯å•ä¾‹
s2 = Singleton.get_instance()  # åªæœ‰è¿™æ ·æ‰èƒ½ä¿è¯å•ä¾‹
```  
ğŸ˜œ **æ³¨æ„ï¼š**
ä¸Šè¿°ä½¿ç”¨ç±» `_instance` å±æ€§åˆ›å»ºçš„å•ä¾‹åœ¨å•çº¿ç¨‹æ¨¡å¼ä¸‹æ˜¯å®‰å…¨çš„ï¼Œä½†æ˜¯åœ¨å¤šçº¿ç¨‹æ¨¡å¼ä¸‹å°±ä¼šå‡ºç°é—®é¢˜ã€‚å› ä¸ºï¼Œåœ¨å¤šçº¿ç¨‹æ¨¡å¼ä¸‹ï¼Œä¸€ä¸ªå¯¹è±¡åˆ›å»ºçš„è¿‡ç¨‹ä¸­ï¼Œå¦å¤–ä¸€ä¸ªå¯¹è±¡ä¹Ÿåˆ›å»ºäº†ï¼Œå½“å®ƒåˆ¤æ–­çš„æ—¶å€™ä¼šå…ˆå»è·å– `_instance` å±æ€§ï¼Œå› ä¸ºè¿™ä¸ªæ—¶å€™è¿˜æ²¡æœ‰åˆ›å»ºçš„è¯å°±ä¼šè°ƒç”¨ `init()` æ–¹æ³•ï¼Œåœ¨å¤šçº¿ç¨‹æƒ…å†µä¸‹ä¼šè¢«å¤šæ¬¡è°ƒç”¨ï¼Œå°±ä¼šäº§ç”Ÿå¤šä¸ªå®ä¾‹ã€‚

### 1.4 ä½¿ç”¨ç±»ï¼ˆåŠ é”ï¼‰
ä¸ºäº†è§£å†³ç±»æ–¹å¼åˆ›å»ºå•ä¾‹åœ¨å¤šçº¿ç¨‹ä¸‹å­˜åœ¨çš„é—®é¢˜ï¼Œå¯ä»¥åœ¨åˆ›å»ºå¯¹è±¡çš„æ—¶å€™è¿›è¡ŒåŠ é”ï¼Œä»è€Œä¿è¯å•ä¾‹çš„æ­£ç¡®æ€§ã€‚

```python
import time
import threading

class Sigleton(object):
    _instance_lock = threading.Lock()
    def __init__(self, *args, **kwargs):
        time.sleep(1)

    @classmethod
    def get_instance(cls, *args, **kwargs):
        if not hasattr(Singleton, "_instance"):
            with Singleton._instance_lock:
                if not hasattr(Singleton, "_instance"):
                    Singleton._instance = Singleton(*args, **kwargs)
        return Singleton._instance


def task(args):
    obj = Singleton.get_instance(args)
    print(obj)


for i in range(10):
    thread = threading.Thread(target=task, args=[i, ])
    thread.start()


obj = Sigleton.get_instance()
print(obj)
```

### 1.5 åŸºäº `__new__` æ–¹æ³•åˆ›å»ºå•ä¾‹

> ä¸€ä¸ªå¯¹è±¡çš„å®ä¾‹åŒ–è¿‡ç¨‹æ˜¯å…ˆæ‰§è¡Œç±»çš„ `__new__` æ–¹æ³•ï¼Œå¦‚æœæ²¡æœ‰æŒ‡å®šï¼Œé»˜è®¤ä¼šä½¿ç”¨ `object` çš„ `__new__` æ–¹æ³•ï¼Œè¿”å›ä¸€ä¸ªå®ä¾‹åŒ–å¯¹è±¡ï¼Œç„¶åå†è°ƒç”¨ `__init__` æ–¹æ³•ï¼Œå¯¹è¿™ä¸ªå¯¹è±¡è¿›è¡Œåˆå§‹åŒ–ï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®è¿™ä¸ªç‰¹æ€§æ¥å®ç°å•ä¾‹ã€‚åœ¨ä¸€ä¸ªç±»çš„ `__new__` æ–¹æ³•ä¸­ï¼Œå…ˆåˆ¤æ–­æ˜¯ä¸æ˜¯å­˜åœ¨å®ä¾‹ï¼Œå¦‚æœå­˜åœ¨å®ä¾‹ï¼Œå°±ç›´æ¥è¿”å›ï¼Œå¦‚æœä¸å­˜åœ¨å®ä¾‹å°±åˆ›å»ºã€‚  

```python
import threading

class Singleton(object):
    _instance_lock = threading.Lock()

    def __init__(self, *args, **kwargs):
        pass

    def __new__(self, *args, **kwargs):
        if not hasattr(cls, "_instance"):
            with Singleton._instance_lock:
                if not hasattr(cls, "_instance"):
                    Singleton._instance = super().__new__(cls)
            return Singleton._instance


obj1 = Singleton()
obj2 = Singleton()

def task(args):
    obj = Singleton()
    print(obj)
```

### 1.6 åŸºäº `metaclass` æ–¹å¼çš„å®ç°
```python
import threading


class SingletonType(type):
    _instance_lock = threading.Lock()
    def __call__(cls, *args, **kwargs):
        if not hasattr(cls, "_instance"):
            with SingletonType._instance_lock:
                if not hasattr(cls, "_instance"):
                    cls._instance = super(SingletonType,cls).__call__(*args, **kwargs)
        return cls._instance


class Foo(metaclass=SingletonType):
    def __init__(self,name):
        self.name = name


obj1 = Foo('name')
obj2 = Foo('name')
print(obj1,obj2)
```
